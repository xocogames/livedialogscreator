<html>

<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="dialogs.css">
    <script>
        let listActorText = [
            "¿Y tú que quieres, novato?",
            "Pues felicidades. Yo soy ${ACTOR}, el cazador. Piérdete y déjame en paz",
            "¿Y a tí que te importa?",
            "¿Escapar? Solo se puede salir de aquí muerto. En eso sí podría ayudarte",
            "¡Pero que gracioso eres, novato! Yo soy ${ACTOR}, el cazador. ¡Me caes bien!",
            "¡Tu de nuevo, ${PLAYER}!. Dime, ¿como te va?",
            "Pues no se, en alguna posada supongo ¿Oye, te vienes mañana a cazar?"
        ];
        let listPlayerText = [
            "Me llamo ${PLAYER}, encantado de saludarte",
            "¿Como te llamas?",
            "Quiero tu ayuda para escapar de aquí",
            "No me llames novato. Me llamo ${PLAYER}, y yo no te he faltado al respeto",
            "Algo mal, no se donde alojarme",
            "Bien! Oye, me gustaría ir mañana contigo a cazar",
            "Oye, esta ${ACTOR:ELVIRA} es rarita, ¿no?",
            "Oye, esa chica, ${ACTOR:HELLEN}, ¿vive con alguien?",
            "Oye, ¿${ACTOR:PANDORA} qué es?",
            "¿Me dejarías quedarme en tu casa?",
            "¿En la posada de ${ACTOR:ELVIRA}?",
            "¡A cazar! Buena idea ¿Cuando y donde quedamos?",
            "No me gusta la caza ni el sufrimiento animal"
        ];

        let uiDialogController = null;

        let refActorNpg = "npg";
        let refActorPlayer = "player";

        let ulElemActor;
        let ulElemPlayer;
        let divCenter;

        class DialogSentence {
            refActor = null;
            idSentence = null;
            textSentence = "";

            constructor(refActor, idSentence, textSentence) {
                this.refActor = refActor;
                this.idSentence = idSentence;
                this.textSentence = textSentence;
            }
        }

        class DialogTreeNode {
            idDialogNode = null;
            idDialogParent = null;
            dialogSentence = null;
            listDialogTreeReplies = [];

            dialogConditionsText = null;
            isValidDialogConditionsText = true;

            dialogActionsText = null;
            isValidDialogActionsText = true;

            constructor(idDialogNode, dialogSentence) {
                this.idDialogNode = idDialogNode;
                this.dialogSentence = dialogSentence;
            }

            getRefActor() {
                return this.dialogSentence.refActor;
            }

            toJson(idDialogParent) {
                let strRet = "";
                let strConditions = "";
                let replyOptions = "";
                let strActions = "";

                for (i = 0; i < this.listDialogTreeReplies.length; i++) {
                    let dialogReply = this.listDialogTreeReplies[i];
                    let jsonReply = "{" + "\"idDialogNode\": \"" + dialogReply.idDialogNode + "\", \"idDialogSentence\": \"" + dialogReply.dialogSentence.idSentence + "\", \"textSentence\": \"" + dialogReply.dialogSentence.textSentence + "\"}";
                    if (i > 0) replyOptions += ",";
                    replyOptions += jsonReply;
                }

                if (this.dialogConditionsText == null) {
                    if (idDialogParent != null) strConditions = "\"conditionsAnd\": [{\"idDialogPrev\": \"" + idDialogParent + "\"}],";
                    else strConditions = "\"conditionsAnd\": [{\"NEXT\": \"\"}],";
                } else {
                    strConditions = "\"conditionsAnd\": " + this.dialogConditionsText + ",";
                }

                if (this.dialogActionsText != null) {
                    strActions = ", \"actions\": " + this.dialogActionsText;
                }

                strRet = "{" + strConditions + "\"idDialogNode\": \"" + this.idDialogNode + "\", \"idDialogSentence\": \"" + this.dialogSentence.idSentence + "\", \"textSentence\": \"" + this.dialogSentence.textSentence + "\", " +
                    "\"replyOptions\": [" + replyOptions + "]" + strActions +
                    "}";

                return strRet;
            }
        }

        class DialogTree {
            listIdDialogTreeRoots = [];
            mapDialogTreeNodes = new Map();

            // mapDialogConditions = new Map();

            clear() {
                this.listIdDialogTreeRoots = [];
                this.mapDialogTreeNodes = new Map();
                // this.mapDialogConditions = new Map();
            }

            createDialogNode(idDialogNode, dialogSentence) {
                var dialogTreeNode = this.mapDialogTreeNodes.get(idDialogNode);
                if (dialogTreeNode == null) {
                    dialogTreeNode = new DialogTreeNode(idDialogNode, dialogSentence);
                    this.mapDialogTreeNodes.set(dialogTreeNode.idDialogNode, dialogTreeNode);
                } else {
                    if (dialogSentence != null && dialogTreeNode.dialogSentence == null) dialogTreeNode.dialogSentence = dialogSentence;
                }
                return dialogTreeNode;
            }

            createReplyDialogNode(idDialogNode, idDialogParent, dialogSentence) {
                var dialogTreeNode = this.mapDialogTreeNodes.get(idDialogNode);
                if (dialogTreeNode == null) {
                    return this.addSentenceReply(idDialogNode, idDialogParent, dialogSentence);
                } else {
                    if (dialogSentence != null && dialogTreeNode.dialogSentence == null) dialogTreeNode.dialogSentence = dialogSentence;

                    var dialogTreeParent = this.mapDialogTreeNodes.get(idDialogParent);
                    if (dialogTreeParent != null) {
                        dialogTreeNode.idDialogParent = dialogTreeParent.idDialogNode;
                        dialogTreeParent.listDialogTreeReplies.push(dialogTreeNode);
                        this.removeDialogFromRoot(dialogTreeNode);
                    }
                    return dialogTreeNode;
                }
            }

            addSentenceReply(idDialogNode, idDialogParent, dialogSentence) {
                var dialogTreeNode = new DialogTreeNode(idDialogNode, dialogSentence);
                var dialogTreeParent = this.mapDialogTreeNodes.get(idDialogParent);
                if (dialogTreeParent != null) {
                    dialogTreeNode.idDialogParent = dialogTreeParent.idDialogNode;
                    dialogTreeParent.listDialogTreeReplies.push(dialogTreeNode);
                    this.mapDialogTreeNodes.set(dialogTreeNode.idDialogNode, dialogTreeNode);
                    return dialogTreeNode;
                } else {
                    if (idDialogParent == null) {
                        this.mapDialogTreeNodes.set(dialogTreeNode.idDialogNode, dialogTreeNode);
                        this.addDialogAsRoot(dialogTreeNode);
                        return dialogTreeNode;
                    }
                }
                return null;
            }

            addDialogAsRoot(dialogNode) {
                this.listIdDialogTreeRoots.push(dialogNode.idDialogNode);
            }

            removeDialogFromRoot(dialogNode) {
                var index = this.listIdDialogTreeRoots.indexOf(dialogNode);
                if (index !== -1) {
                    this.listIdDialogTreeRoots.splice(index, 1);
                }
            }

            getTreeNode(idDialogNode) {
                if (idDialogNode == null) {
                    if (this.listIdDialogTreeRoots.length > 0) idDialogNode = this.listIdDialogTreeRoots[0];
                    else return null;
                }
                var dialogTreeNode = this.mapDialogTreeNodes.get(idDialogNode);
                return dialogTreeNode;
            }

            getListIdsDialogRoots() {
                return this.listIdDialogTreeRoots;
            }

            getListIdsDialogTreeReplies(idDialogNode) {
                var listIdsDialogReplies = [];

                var dialogTreeNode = this.getTreeNode(idDialogNode);
                if (dialogTreeNode != null) {
                    for (var i = 0; i < dialogTreeNode.listDialogTreeReplies.length; i++) {
                        listIdsDialogReplies.push(dialogTreeNode.listDialogTreeReplies[i].idDialogNode);
                    }
                }
                return listIdsDialogReplies;
            }

            getListIdsDialogTreeBrothers(idDialogNode) {
                var dialogTreeNode = this.getTreeNode(idDialogNode);
                if (dialogTreeNode != null) {
                    if (dialogTreeNode.idDialogParent != null) {
                        return this.getListIdsDialogTreeReplies(dialogTreeNode.idDialogParent);
                    } else return this.listIdDialogTreeRoots;
                }
                return [];
            }

            setDialogConditions(idDialogNode, conditionsText, isValidJson) {
                var dialogTreeNode = this.getTreeNode(idDialogNode);
                if (dialogTreeNode != null) {
                    dialogTreeNode.dialogConditionsText = conditionsText;
                    dialogTreeNode.isValidDialogConditionsText = isValidJson;
                }
            }

            getDialogConditions(idDialogNode) {
                var dialogTreeNode = this.getTreeNode(idDialogNode);
                if (dialogTreeNode != null) return dialogTreeNode.dialogConditionsText;
            }

            setDialogActions(idDialogNode, actionsText, isValidJson) {
                var dialogTreeNode = this.getTreeNode(idDialogNode);
                if (dialogTreeNode != null) {
                    dialogTreeNode.dialogActionsText = actionsText;
                    dialogTreeNode.isValidDialogActionsText = isValidJson;
                }
            }

            getDialogActions(idDialogNode) {
                var dialogTreeNode = this.getTreeNode(idDialogNode);
                if (dialogTreeNode != null) return dialogTreeNode.dialogActionsText;
            }
        }

        class UIPanelSentences {
            refActor = null;
            ulElem = null;
            elemParent = null;
            mapSentences = new Map();

            constructor(ulElem, refActor) {
                this.ulElem = ulElem;
                this.elemParent = ulElem.parentElement;
                this.refActor = refActor;
            }

            clear() {
                this.mapSentences.clear();
                this.ulElem.innerHTML = "";
            }

            createDialogSentence(text) {
                return this.createDialogSentenceWithId(uuid(), text);
            }

            createDialogSentenceWithId(id, text) {
                var dialogSentence = new DialogSentence(this.refActor, id, text);
                this.mapSentences.set(dialogSentence.idSentence, dialogSentence);
                return dialogSentence;
            }

            getSentence(idSentence) {
                return this.mapSentences.get(idSentence);
            }

            filterPanelSentences(textFilter) {
                let i = 0;
                for (const [idSentence, dialogSentence] of this.mapSentences.entries()) {
                    var divElem = document.getElementById("LIST-" + idSentence);
                    if (dialogSentence.textSentence.includes(textFilter)) divElem.style.display = "block";
                    else divElem.style.display = "none";
                    i++;
                }
            }

            disable() {
                this.elemParent.className = "disabled";
            }

            enable() {
                this.elemParent.className = "";
            }
        }

        class UIDialogController {
            uiPanelSentencesNpg = null;
            uiPanelSentencesPlayer = null;

            dialogTree = new DialogTree();

            idDialogTreeNodeSelected = null;

            constructor() {
                ulElemActor = document.getElementById("ulListActor");
                ulElemPlayer = document.getElementById("ulListPlayer");
                divCenter = document.getElementById("content-dialog");

                this.uiPanelSentencesNpg = new UIPanelSentences(ulElemActor, refActorNpg);
                this.uiPanelSentencesPlayer = new UIPanelSentences(ulElemPlayer, refActorPlayer);
                this.uiPanelSentencesPlayer.disable();
            }

            clear() {
                divCenter.innerHTML = "";

                this.dialogTree.clear();
                this.uiPanelSentencesNpg.clear();
                this.uiPanelSentencesPlayer.clear();
                this.uiPanelSentencesNpg.enable();
                this.uiPanelSentencesPlayer.disable();
            }

            changeEnabledUiPanelSentences(refActor) {
                if (this.uiPanelSentencesNpg.refActor == refActor) {
                    this.uiPanelSentencesNpg.disable();
                    this.uiPanelSentencesPlayer.enable();
                } else {
                    this.uiPanelSentencesNpg.enable();
                    this.uiPanelSentencesPlayer.disable();
                }
            }

            resetDialog() {
                ulElemActor.innerHTML = '';
                ulElemPlayer.innerHTML = '';
            }

            setRefActorNpg(refActor) {
                document.getElementById("text-npgActor").value = refActor;
            }

            setRefActorPlayer(refActor) {
                document.getElementById("text-playerActor").value = refActor;
            }

            createNpgPanelSentence(text) {
                var dialogSentence = this.uiPanelSentencesNpg.createDialogSentence(text);
                this.buildLateralPanel(ulElemActor, dialogSentence, false);
            }


            createNpgPanelSentenceWithId(id, text) {
                var dialogSentence = this.uiPanelSentencesNpg.createDialogSentenceWithId(id, text);
                this.buildLateralPanel(ulElemActor, dialogSentence, false);
            }

            getSentenceNpg(idSentence) {
                return this.uiPanelSentencesNpg.getSentence(idSentence);
            }

            createPlayerPanelSentence(text) {
                var dialogSentence = this.uiPanelSentencesPlayer.createDialogSentence(text);
                this.buildLateralPanel(ulElemPlayer, dialogSentence, true);
            }

            createPlayerPanelSentenceWithId(id, text) {
                var dialogSentence = this.uiPanelSentencesPlayer.createDialogSentenceWithId(id, text);
                this.buildLateralPanel(ulElemPlayer, dialogSentence, true);
            }

            getSentencePlayer(idSentence) {
                return this.uiPanelSentencesPlayer.getSentence(idSentence);
            }

            addDialogReply(idDialogReply, dialogSentence) {
                var dialogTreeReply = this.dialogTree.getTreeNode(idDialogReply);
                if (dialogTreeReply != null || idDialogReply == null) {
                    var dialogTreeNode = this.dialogTree.addSentenceReply(uuid(), idDialogReply, dialogSentence);
                    return dialogTreeNode;
                }
                return null;
            }

            showDialogTreeNode(dialogTreeNode, alignRight, expand) {
                var divDialogNode = document.createElement("div");
                divDialogNode.id = dialogTreeNode.idDialogNode;
                divDialogNode.appendChild(document.createTextNode(dialogTreeNode.dialogSentence.textSentence));
                if (alignRight) divDialogNode.setAttribute("align", "right");
                divCenter.appendChild(divDialogNode);

                if (this.isValidDialogJson(dialogTreeNode.idDialogNode)) divDialogNode.style.color = "black";
                else divDialogNode.style.color = "red";

                divDialogNode.addEventListener('click', function(ev) {
                    if (ev.target) {
                        var divDialogNode = ev.target;
                        uiDialogController.selectOffDialogTreeNode(uiDialogController.idDialogTreeNodeSelected);
                        uiDialogController.selectOnDialogTreeNode(divDialogNode.id);
                        uiDialogController.selectOffDialogTreeBrothers(divDialogNode.id);

                        uiDialogController.removeDialogPanelTo(divDialogNode.id);
                        uiDialogController.showDialogTreeReplies(divDialogNode.id);

                        var isJsonConditionsOk = uiDialogController.showDialogConditions(divDialogNode.id);
                        if (!isJsonConditionsOk) uiDialogController.selectRedDialogTreeNode(divDialogNode.id);

                        var isJsonActionsOk = uiDialogController.showDialogActions(divDialogNode.id);
                        if (!isJsonActionsOk) uiDialogController.selectRedDialogTreeNode(divDialogNode.id);
                    }
                });
            }

            selectOnDialogTreeNode(idDialogNode) {
                var dialogTreeSelected = this.dialogTree.getTreeNode(idDialogNode);
                if (dialogTreeSelected != null) {
                    var divDialogNode = document.getElementById(dialogTreeSelected.idDialogNode);
                    if (divDialogNode != null) {
                        divDialogNode.style.color = "blue";
                        divDialogNode.style.fontWeight = "bold";

                        this.idDialogTreeNodeSelected = idDialogNode;
                        this.changeEnabledUiPanelSentences(dialogTreeSelected.getRefActor());
                    }
                }
            }

            selectOffDialogTreeNode(idDialogNode) {
                var dialogTreeSelected = this.dialogTree.getTreeNode(idDialogNode);
                if (dialogTreeSelected != null) {
                    var divDialogNode = document.getElementById(dialogTreeSelected.idDialogNode);
                    if (divDialogNode != null) {
                        if (this.isValidDialogJson(idDialogNode)) divDialogNode.style.color = "black";
                        else divDialogNode.style.color = "red";
                    }
                }
            }

            selectOffDialogTreeBrothers(idDialogNode) {
                var listIdsDialogBrothers = this.dialogTree.getListIdsDialogTreeBrothers(idDialogNode);
                for (var i = 0; i < listIdsDialogBrothers.length; i++) {
                    var idDialogBrother = listIdsDialogBrothers[i];
                    if (idDialogBrother != idDialogNode) {
                        var divDialogBrother = document.getElementById(idDialogBrother);
                        if (divDialogBrother != null) {
                            if (this.isValidDialogJson(idDialogBrother)) {
                                divDialogBrother.style.color = "black";
                                divDialogBrother.style.fontWeight = "normal";
                            } else {
                                divDialogBrother.style.color = "red";
                                divDialogBrother.style.fontWeight = "normal";
                            }
                        }
                    }
                }
            }

            selectRedDialogTreeNode(idDialogNode) {
                var dialogTreeRed = this.dialogTree.getTreeNode(idDialogNode);
                if (dialogTreeRed != null) {
                    var divDialogNode = document.getElementById(dialogTreeRed.idDialogNode);
                    if (divDialogNode != null) {
                        divDialogNode.style.color = "red";
                    }
                }
            }

            buildLateralPanel(elemPanel, dialogSentence, alignRight) {
                var idSentence = dialogSentence.idSentence;
                var textSentence = dialogSentence.textSentence;

                var item = document.createElement('li');

                var divLine = item.appendChild(document.createElement("div"));
                divLine.id = "LIST-" + dialogSentence.idSentence;
                divLine.style.cssText = "display:inline";
                var divText = divLine.appendChild(document.createElement("div"));
                divText.style.cssText = "display:inline";
                var divArrow = divLine.appendChild(document.createElement("div"));
                divArrow.style.cssText = "display:inline";

                divText.appendChild(document.createTextNode(textSentence));
                divText.dialogSentence = dialogSentence;
                divText.idSentence = idSentence;

                divArrow.appendChild(document.createTextNode(" > "));
                divArrow.dialogSentence = dialogSentence;
                divArrow.textShow = textSentence;

                divArrow.addEventListener('click', function(e) {
                    if (e.target) {
                        var dialogTreeNode = uiDialogController.addDialogReply(uiDialogController.idDialogTreeNodeSelected, e.currentTarget.dialogSentence);
                        uiDialogController.showDialogTreeNode(dialogTreeNode, alignRight, false);
                    }
                });

                elemPanel.appendChild(item);
            }

            getListdDivDialogNodesReverse() {
                var listNodes = [];
                var childDivs = divCenter.getElementsByTagName('div');

                for (var i = childDivs.length; i > 0; i--) {
                    listNodes.push(childDivs[i - 1]);
                }
                return listNodes;
            }

            removeDialogPanelTo(idDialogNode) {
                var listDivDialogNodes = this.getListdDivDialogNodesReverse();
                var listLimitIdsDialogNodes = this.dialogTree.getListIdsDialogTreeBrothers(idDialogNode);

                for (var i = 0; i < listDivDialogNodes.length; i++) {
                    var divElem = listDivDialogNodes[i];
                    if (divElem.id == idDialogNode || listLimitIdsDialogNodes.includes(divElem.id)) return;

                    divCenter.removeChild(divElem);
                }
            }

            showDialogTreeReplies(idDialogNode) {
                var alignRightChilds = false;
                var dialogNode = this.dialogTree.getTreeNode(idDialogNode);
                if (dialogNode != null) {
                    if (dialogNode.getRefActor() == refActorNpg) alignRightChilds = true;

                    for (var i = 0; i < dialogNode.listDialogTreeReplies.length; i++) {
                        var dialogReplyNode = dialogNode.listDialogTreeReplies[i];
                        this.showDialogTreeNode(dialogReplyNode, alignRightChilds, false);
                    }
                }
            }

            isValidDialogJson(idDialogNode) {
                return this.isValidDialogConditionsJson(idDialogNode) && this.isValidDialogActionsJson(idDialogNode);
            }

            isValidDialogConditionsJson(idDialogNode) {
                var dialogNode = this.dialogTree.getTreeNode(idDialogNode);
                return dialogNode.isValidDialogConditionsText;
            }

            isValidDialogActionsJson(idDialogNode) {
                var dialogNode = this.dialogTree.getTreeNode(idDialogNode);
                return dialogNode.isValidDialogActionsText;
            }

            showDialogConditions(idDialogNode) {
                console.log("showDialogConditions");
                var conditionsArea = document.getElementById("areaConditions");
                console.log(" - conditionsArea: " + conditionsArea);

                var dialogNode = this.dialogTree.getTreeNode(idDialogNode);
                if (dialogNode.dialogConditionsText != null) {
                    console.log(" - conditionsText: " + dialogNode.dialogConditionsText);
                    conditionsArea.value = dialogNode.dialogConditionsText;
                    console.log(" - conditionsArea.value: " + conditionsArea.value);
                    return dialogNode.isValidDialogConditionsText;
                }
                // conditionsArea.value = "[\n]";
                this.showDialogConditionsDefault(conditionsArea, idDialogNode);
                return true;
            }

            showDialogActions(idDialogNode) {
                console.log("showDialogActions");
                var actionsArea = document.getElementById("areaActions");
                console.log(" - actionsArea: " + actionsArea);

                var dialogNode = this.dialogTree.getTreeNode(idDialogNode);
                if (dialogNode.dialogActionsText != null) {
                    console.log(" - dialogActionsText: " + dialogNode.dialogActionsText);
                    actionsArea.value = dialogNode.dialogActionsText;
                    console.log(" - actionsArea.value: " + actionsArea.value);
                    return dialogNode.isValidDialogActionsText;
                }
                actionsArea.value = "";
                return true;
            }

            showDialogConditionsDefault(conditionsArea, idDialogNode) {
                var dialogNode = this.dialogTree.getTreeNode(idDialogNode);
                if (dialogNode != null) {
                    if (dialogNode.idDialogParent == null) conditionsArea.value = "[\n   \{\"NEXT\": \"\"\}\n\]";
                    else conditionsArea.value = "[\n   \{\"idDialogPrev\": \"" + dialogNode.idDialogParent + "\"\}\n\]";
                }
            }

            storeDialogSelectedConditions() {
                console.log("storeDialogSelectedConditions");
                var conditionsText = document.getElementById("areaConditions").value;
                console.log(" - conditionsText: " + conditionsText);
                var isValidJson = false;
                if (conditionsText != null && conditionsText.trim().length > 0) {
                    if (isJson(conditionsText)) {
                        console.log("SI que es un JSON valido");
                        if (isValidJson = this.validateJsonArray(conditionsText) == true) {
                            console.log("Y además es un array");
                        } else {
                            console.log("¿Pero no es un array?");
                        }
                    } else {
                        console.log("ERROR. NO es un JSON valido");
                    }
                    this.dialogTree.setDialogConditions(this.idDialogTreeNodeSelected, conditionsText, isValidJson);
                    console.log(" - storedText: idDialogTreeNodeSelected = " + this.idDialogTreeNodeSelected);
                }
                document.getElementById("areaConditions").value = "";
            }

            storeDialogSelectedActions() {
                console.log("storeDialogSelectedActions");
                var actionsText = document.getElementById("areaActions").value;
                console.log(" - actionsText: " + actionsText);
                var isValidJson = false;
                if (actionsText != null && actionsText.trim().length > 0) {
                    if (isJson(actionsText)) {
                        console.log("SI que es un JSON valido");
                        if (isValidJson = this.validateJsonArray(actionsText) == true) {
                            console.log("Y además es un array");
                        } else {
                            console.log("¿Pero no es un array?");
                        }
                    } else {
                        console.log("ERROR. NO es un JSON valido");
                    }
                    this.dialogTree.setDialogActions(this.idDialogTreeNodeSelected, actionsText, isValidJson);
                    console.log(" - storedText: idDialogTreeNodeSelected = " + this.idDialogTreeNodeSelected);
                }
                document.getElementById("areaActions").value = "";
            }

            validateJsonArray(jsonArrayText) {
                var jsonObjArray = getJsonObject(jsonArrayText);
                if (jsonObjArray != null && Array.isArray(jsonObjArray)) return true;
                return false;
            }

            // ********************************************************************************************************************* //
            // JSON Build

            buildDialogJSON() {
                let strDialogSW = "\"dialogSW\": \"www.livedialogs.com\"";
                let strDialogVersion = "\"dialogVersion\": \"0.0.1\"";
                let strPrj = "\"refPrj\": \"" + document.getElementById("text-prj").value + "\"";
                let strPrjVersion = "\"versionPrj\": \"0.0.1\"";
                let strPage = "\"page\": \"" + document.getElementById("text-page").value + "\"";
                let strActorNpg = "\"refActorNpg\": \"" + document.getElementById("text-npgActor").value + "\"";
                let strActorPlayer = "\"refActorPlayer\": \"" + document.getElementById("text-playerActor").value + "\"";
                let strNpgSentences = this.buildNpgDialogsJson();
                let strPlayerSentences = this.buildPlayerDialogsJson();
                return "{ " +
                    strDialogSW + ",\n" +
                    strDialogVersion + ",\n" +
                    strPrj + ",\n" +
                    strPrjVersion + ",\n" +
                    strPage + ",\n" +
                    strActorNpg + ",\n" +
                    strActorPlayer + ",\n" +
                    strNpgSentences + ",\n" +
                    strPlayerSentences + ",\n" +
                    this.buildDialogThreadsJson(refActorNpg, true) +
                    ",\n" + this.buildDialogThreadsJson(refActorPlayer, false) +
                    " }";
            }

            buildNpgDialogsJson() {
                let strActorDialogs = "";
                let i = 0;
                for (const [key, value] of this.uiPanelSentencesNpg.mapSentences.entries()) {
                    if (i > 0) strActorDialogs += ",\n";
                    strActorDialogs += "{ \"id\": \"" + key + "\", \"text\": \"" + value.textSentence + "\"}";
                    i++;
                }
                strActorDialogs = "\"npgSentences\": [" + strActorDialogs + "]";
                return strActorDialogs;
            }

            buildPlayerDialogsJson() {
                let strPlayerDialogs = "";
                let i = 0;
                for (const [key, value] of this.uiPanelSentencesPlayer.mapSentences.entries()) {
                    if (i > 0) strPlayerDialogs += ",\n";
                    strPlayerDialogs += "{ \"id\": \"" + key + "\", \"text\": \"" + value.textSentence + "\"}";
                    i++;
                }
                strPlayerDialogs = "\"playerSentences\": [" + strPlayerDialogs + "]";
                return strPlayerDialogs;
            }

            buildDialogActorJson(refActor, isNpg) {
                var jsonActor = "";

                if (isNpg) jsonActor += "\"actorDialogNpg\": ";
                else jsonActor += "\"actorDialogPlayer\": ";
                jsonActor += "{ \"refActor\": \"" + refActor + "\", " + this.buildDialogThreadsJson(refActor) + "}";

                return jsonActor;
            }

            buildDialogThreadsJson(refActor, isNpg) {
                var jsonActor = "";
                if (isNpg) jsonActor += "\"npgDialog\": ";
                else jsonActor += "\"playerDialog\": ";

                let jsonDialogs = "";
                let i = 0;

                for (var j = 0; j < this.dialogTree.listIdDialogTreeRoots.length; j++) {
                    var dialogNode = this.dialogTree.getTreeNode(this.dialogTree.listIdDialogTreeRoots[j]);
                    if (dialogNode.getRefActor() == refActor) {
                        if (i > 0) jsonDialogs += ",\n";
                        jsonDialogs += dialogNode.toJson(null);
                        i++;
                    }
                }

                for (const [key, dialogNode] of this.dialogTree.mapDialogTreeNodes.entries()) {
                    if (dialogNode.getRefActor() != refActor) {
                        var listDialogReplies = dialogNode.listDialogTreeReplies;
                        for (var r = 0; r < listDialogReplies.length; r++) {
                            var dialogReply = listDialogReplies[r];
                            if (i > 0) jsonDialogs += ",\n";
                            jsonDialogs += dialogReply.toJson(dialogNode.idDialogNode);
                            i++;
                        }
                    }
                }
                return jsonActor + "[ " + jsonDialogs + " ]";
            }
        }

        function uuid() {
            return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        function start() {
            uiDialogController = new UIDialogController();
            uiDialogController.resetDialog();

            for (i = 0; i < listActorText.length; i++) {
                uiDialogController.createNpgPanelSentence(listActorText[i]);
            }

            for (i = 0; i < listPlayerText.length; i++) {
                uiDialogController.createPlayerPanelSentence(listPlayerText[i]);
            }
        }

        function addNpgSentence() {
            var inputText = document.getElementById("text-actor").value;
            var ulElem = document.getElementById("ulListActor");
            uiDialogController.createNpgPanelSentence(inputText);
        }

        function addPlayerSentence() {
            var inputText = document.getElementById("text-player").value;
            var ulElem = document.getElementById("ulListPlayer");
            uiDialogController.createPlayerPanelSentence(inputText);
        }

        function filterNpgSentences(event) {
            var inputText = event.target.value;
            uiDialogController.uiPanelSentencesNpg.filterPanelSentences(inputText);
        }

        function filterPlayerSentences(event) {
            var inputText = event.target.value;
            uiDialogController.uiPanelSentencesPlayer.filterPanelSentences(inputText);
        }

        function setSelectedConditionsText(event) {
            // var conditionsText = document.getElementById("areaConditions").value;
            uiDialogController.storeDialogSelectedConditions();
        }

        function setSelectedActionsText(event) {
            // var conditionsText = document.getElementById("areaConditions").value;
            uiDialogController.storeDialogSelectedActions();
        }

        function clearAll() {
            uiDialogController.clear();
        }

        function buildDialogJSON() {
            var jsonStr = uiDialogController.buildDialogJSON();
            // console.log("JSON:\n " + jsonStr);

            var modal = document.getElementById("modalJson");
            var modalContent = document.getElementById("modalJsonContent");
            var modalArea = document.getElementById("modalJsonArea");
            modalArea.innerHTML = JSON.stringify(JSON.parse(jsonStr), undefined, 4);
            modal.style.display = "block";
        }

        class DialogJsonBuilder {
            uiDialogController = null;
            dialogTree = null;
            jsonObjContent = null;

            constructor(uiDialogController) {
                this.uiDialogController = uiDialogController;
                this.dialogTree = uiDialogController.dialogTree;
            }

            buildDialogs(jsonContent) {

                uiDialogController.uiPanelSentencesNpg.clear();
                uiDialogController.uiPanelSentencesPlayer.clear();

                this.jsonObjContent = new JsonObjectParser();
                this.jsonObjContent.buildByJson(jsonContent);

                this.buildActors();
                this.buildDialogSentences();
                this.buildDialogActor("npgDialog");
                this.buildDialogActor("playerDialog");

                this.showRootElem();
            }

            buildActors() {
                uiDialogController.setRefActorNpg(this.jsonObjContent.getField("refActorNpg"));
                uiDialogController.setRefActorPlayer(this.jsonObjContent.getField("refActorPlayer"));
            }

            buildDialogSentences() {
                this.buildDialogSentencesNpg();
                this.buildDialogSentencesPlayer();
            }

            buildDialogSentencesNpg() {
                var jsonSentencesParser = new JsonObjectParser();
                jsonSentencesParser.buildByObject(this.jsonObjContent.getField("npgSentences"));

                for (var i = 0; i < jsonSentencesParser.getArrayObjects().length; i++) {
                    // console.log("- Sentence: ["+ i + "] = "+ jsonSentencesParser.getArrayObjects()[i]);
                    var jsonSentenceObj = new JsonObjectParser().buildByObject(jsonSentencesParser.getArrayObjects()[i]);
                    uiDialogController.createNpgPanelSentenceWithId(jsonSentenceObj.getField("id"), jsonSentenceObj.getField("text"));
                }
            }

            buildDialogSentencesPlayer() {
                var jsonSentencesParser = new JsonObjectParser();
                jsonSentencesParser.buildByObject(this.jsonObjContent.getField("playerSentences"));

                for (var i = 0; i < jsonSentencesParser.getArrayObjects().length; i++) {
                    // console.log("- Sentence: [" + i + "] = " + jsonSentencesParser.getArrayObjects()[i]);
                    var jsonSentenceObj = new JsonObjectParser().buildByObject(jsonSentencesParser.getArrayObjects()[i]);
                    uiDialogController.createPlayerPanelSentenceWithId(jsonSentenceObj.getField("id"), jsonSentenceObj.getField("text"));
                }
            }

            buildDialogActor(refActor, withReplies) {
                var jsonDialogParser = new JsonObjectParser();
                jsonDialogParser.buildByObject(this.jsonObjContent.getField(refActor));

                for (var i = 0; i < jsonDialogParser.getArrayObjects().length; i++) {
                    var jsonDialogObj = new JsonObjectParser().buildByObject(jsonDialogParser.getArrayObjects()[i]);

                    var idDialogElem = jsonDialogObj.getField("idDialogNode");
                    var idSentence = jsonDialogObj.getField("idDialogSentence");

                    // console.log("- Dialog: [" + i + "] = " + idDialogElem);

                    var dialogSentence = this.getSentence(refActor, idSentence);
                    var dialogNode = this.dialogTree.createDialogNode(idDialogElem, dialogSentence);

                    var isDialogRoot = false;
                    var jsonDialogConditions = new JsonObjectParser().buildByObject(jsonDialogObj.getField("conditionsAnd"));
                    if (jsonDialogConditions != null) {
                        var jsonConditionFirst = new JsonObjectParser().buildByObject(jsonDialogConditions.getArrayObjects()[0]);
                        isDialogRoot = jsonConditionFirst.containsField("FIRST");
                        if (!isDialogRoot) isDialogRoot = jsonConditionFirst.containsField("NEXT");
                    }

                    var jsonDialogReplies = new JsonObjectParser().buildByObject(jsonDialogObj.getField("replyOptions"));
                    for (var r = 0; r < jsonDialogReplies.getArrayObjects().length; r++) {
                        var jsonReplyObj = new JsonObjectParser().buildByObject(jsonDialogReplies.getArrayObjects()[r]);
                        var idDialogChild = jsonReplyObj.getField("idDialogNode");
                        var idSentenceChild = jsonReplyObj.getField("idDialogSentence");
                        var dialogSentenceChild = this.getSentence(refActor == "npgDialog" ? "playerDialog" : "npgDialog", idSentenceChild);

                        var dialogNodeChild = this.dialogTree.createReplyDialogNode(idDialogChild, idDialogElem, dialogSentenceChild);

                        // console.log("  -> Child: [" + r + "] = " + dialogNodeChild.idDialogNode);
                    }

                    var jsonDialogConditions = new JsonObjectParser().buildByObject(jsonDialogObj.getField("conditionsAnd"));
                    if (jsonDialogConditions != null) {
                        console.log("JSon Conditions. idDialogNode = " + idDialogElem + " / conditions = \n" + jsonDialogConditions);
                        var conditionsText = JSON.stringify(jsonDialogConditions.objJson, undefined, 4);
                        this.dialogTree.setDialogConditions(idDialogElem, conditionsText, true);
                    }

                    var fieldActions = jsonDialogObj.getField("actions");
                    if (fieldActions != null) {
                        var jsonDialogActions = new JsonObjectParser().buildByObject(fieldActions);
                        if (jsonDialogActions != null) {
                            console.log("JSon Actions. idDialogNode = " + idDialogElem + " / actions = \n" + jsonDialogActions);
                            var actionsText = JSON.stringify(jsonDialogActions.objJson, undefined, 4);
                            this.dialogTree.setDialogActions(idDialogElem, actionsText, true);
                        }
                    }

                    if (isDialogRoot) {
                        this.dialogTree.addDialogAsRoot(dialogNode);
                    }
                }
            }

            showRootElem() {
                // var dialogNodeRoot = this.dialogTree.getTreeNode(null);
                // this.uiDialogController.showDialogTreeNode(dialogNodeRoot, false, false);

                var idDialogRoot = null;
                var listIdsDialogRoots = this.dialogTree.getListIdsDialogRoots();
                for (var idx = 0; idx < listIdsDialogRoots.length; idx++) {
                    var dialogNodeRoot = this.dialogTree.getTreeNode(listIdsDialogRoots[idx]);
                    this.uiDialogController.showDialogTreeNode(dialogNodeRoot, false, false);
                }
            }

            getSentence(refActor, idSentence) {
                return refActor == "npgDialog" ? uiDialogController.getSentenceNpg(idSentence) : uiDialogController.getSentencePlayer(idSentence);
            }
        }





        // *************************************************************************************************************** //
        // Carga de ficheros y Parser genérico de JSONs
        // *************************************************************************************************************** //

        function readFile(file) {
            return new Promise((resolve, reject) => {
                let fr = new FileReader();
                fr.onload = x => resolve(fr.result);
                fr.readAsText(file);
            })
        }

        async function read(input) {
            var jsonContentLoaded = await readFile(input.files[0]);

            var dialogBuilder = new DialogJsonBuilder(uiDialogController);
            dialogBuilder.buildDialogs(jsonContentLoaded);
        }

        function getJsonObject(str) {
            try {
                return JSON.parse(str);
            } catch (e) { // Error: JSON is not okay
                return null;
            }
        }

        const isJson = (str) => {
            try {
                JSON.parse(str);
            } catch (e) { // Error: JSON is not okay
                return false;
            }
            return true;
        }

        class JsonObjectParser {
            objJson = null;
            mapKeyValues = new Map();
            listObjects = [];

            buildByJson(jsonDoc) {
                this.buildByObject(JSON.parse(jsonDoc));
            }

            buildByObject(objJson) {
                this.objJson = objJson;
                if (Array.isArray(this.objJson)) {
                    for (var i = 0; i < this.objJson.length; i++) {
                        this.listObjects.push(this.objJson[i]);
                        // console.log(" > JsonObjectParser.array: ["+ i +"] = "+ this.objJson[i]);
                    }
                } else {
                    var keys = Object.keys(this.objJson);
                    for (var key in keys) {
                        this.mapKeyValues.set(keys[key], this.objJson[keys[key]]);
                        // console.log(" > JsonObjectParser.map: "+ key +" : "+ keys[key] + " = "+ this.objJson[keys[key]]);
                    }
                }
                return this;
            }

            containsField(name) {
                return this.mapKeyValues.has(name);
            }

            getField(name) {
                return this.mapKeyValues.get(name);
            }

            getArrayObjects() {
                return this.listObjects;
            }

            iteratorEntries() {
                // for (const [key, value] of this.mapKeyValues.entries()) { ... }
                return this.mapKeyValues.entries();
            }
        }
    </script>
    <style type="text/css">
        #content {
            display: flex;
            flex-direction: row;
            flex-wrap: wrap;
        }
        
        #content-left {
            width: 35%;
        }
        
        #content-center {
            width: 35%;
        }
        
        #content-right {
            width: 30%;
        }
        
        .disabled {
            opacity: 0.6;
            pointer-events: none;
        }
    </style>
</head>

<body onload="start()">

    <div>
        <strong>Proyecto</strong><input type="text" id="text-prj" maxlength="100" size="50"> <br>
        <strong>Página</strong><input type="text" id="text-page" maxlength="100" size="50"> <br><br>
        <strong>Actor NPG</strong><input type="text" id="text-npgActor" value="Elvira" maxlength="100" size="50"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <strong>Actor Player</strong><input type="text" id="text-playerActor" value="Ramoncín" maxlength="100" size="50"><br>
        <br>
        <a href="javascript:void(0)" onclick="clearAll();">(CLEAR)</a> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
        <strong>Cargar fichero</strong>: <input type="file" onchange="read(this)" />
        <h3>Content:</h3><pre id="msg"></pre>
        <p>
    </div>

    <div id="content">
        <div id="content-left" align="left">
            <strong>Sentencias del actor</strong>
            <ul id="ulListActor">
                <li>Yo digo tal</li>
                <li>I ara pasacual</li>
            </ul>
            <input type="text" id="text-actor" name="text-actor" maxlength="100" size="50" onInput="filterNpgSentences(event)">
            <a href="javascript:void(0)" onclick="addNpgSentence();">+</a>
        </div>

        <div id="content-center" align="left">
            <strong>Diálogo combinado</strong><br><br>
            <div id="content-dialog" align="left">
            </div>
            <p>
                <input type="button" value="JSON" onclick="buildDialogJSON();">
            </p>
            <p>
                <strong>Condiciones AND</strong> (ha de ser array):
                <textarea id="areaConditions" name="areaConditions" rows="15" cols="75" placeholder="[
]" onfocusout="setSelectedConditionsText(event)"></textarea>
            </p>
            <p>
                <strong>Acciones:</strong> (ha de ser array):
                <textarea id="areaActions" name="areaActions" rows="10" cols="75" placeholder="[
]" onfocusout="setSelectedActionsText(event)"></textarea>
            </p>
        </div>

        <div id="content-right" align="left">
            <strong>Sentencias del jugador</strong>
            <ul id="ulListPlayer">
                <li>Esta es mi respuesta</li>
                <li>O bien es esta otra</li>
            </ul>
            <input type="text" id="text-player" name="text-player" maxlength="100" size="50" onInput="filterPlayerSentences(event)">
            <a href="javascript:void(0)" onclick="addPlayerSentence();">+</a>
        </div>
    </div>

    <div id="modalJson" class="modal">
        <!-- Modal content -->
        <div class="modal-content">
            <span class="close" onclick="event.target.parentElement.parentElement.style.display = 'none'">&times;</span>
            <span class="copy" onclick="copyTo();">&#9744;</span>
            <p id="modalJsonContent">Dialog JSON:</p>
            <textarea id="modalJsonArea" name="textarea" rows="30" cols="120">Write something here</textarea>
        </div>
    </div>


</body>

</html>